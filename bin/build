#!/bin/bash

# bug workaround, can be removed with jspm 0.17
jspm_install() {
    LOCK=web/jspm/config.js
    BACKUP=${LOCK}~backup
    cp ${LOCK} ${BACKUP}
    node_modules/.bin/jspm install --log warn --yes
    mv -f ${BACKUP} ${LOCK}
}

case "$2" in
    -w)
        TASK="watch"
    ;;

    *)
        TASK="build"
    ;;
esac

case "$1" in
    dev)
        rm -rf app/cache
        composer install --no-interaction
        npm install
        jspm_install
        node_modules/.bin/gulp ${TASK} --env=dev
    ;;

    prod)
        rm -rf app/cache
        composer install
        npm install
        jspm_install
        node_modules/.bin/gulp ${TASK} --env=prod
    ;;

    *)
        echo -e "Usage: bin/build <dev|prod> [-w]";
    ;;
esac
